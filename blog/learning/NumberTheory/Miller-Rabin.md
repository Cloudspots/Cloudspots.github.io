# Miller-Rabin 算法学习笔记

a.k.a [U573411 【模板】Miller-Rabin](https://www.luogu.com.cn/problem/U573411) 题解。这题数据我造的。但是造数据的时候还不会 Miller-Rabin（用的 0Io_oI0 巨佬的代码）所以现在学一下。

我们下面的讨论都默认在正整数范围内讨论，即不会出现非质数且非合数的情况。

众所周知，判断一个质数非常简单。我们只需要根据质数的定义，枚举所有在 $2$ 和 $n-1$ 之间的数字有没有 $n$ 的因数，如果有则不是质数，否则是质数。时间复杂度 $\mathcal O(\log n)$。

一个小优化：如果 $n$ 有一个在 $2$ 和 $n-1$ 之间的因子 $k$，则 $\dfrac{n}{k}$ 也是 $n$ 的一个因子。那么如果 $k\le \sqrt{n}$ 则 $\min(k,\dfrac{n}{k})\le \sqrt{n}$，否则 $\dfrac{n}{k}\le \dfrac{n}{\sqrt{n}}=\sqrt{n}$，所以 $\min(k,\dfrac{n}{k})\le\sqrt{n}$。换句话说，如果 $n$ 存在一个 $2$ 到 $n-1$ 之间的因子，则必然有 $2$ 到 $\sqrt{n}$ 之间的因子。

所以我们只需要枚举 $2$ 到 $\sqrt{n}$ 之间的质数即可。代码：

```cpp
bool isprime(long long n)
{
    // 其实，我们这里并不需要算 sqrt(n)
    // 我们只需要在每次循环的时候判断 i<=sqrt(n)
    // 也就是 i*i<=n
    // 但是可能溢出，所以可以改为 i<=n/i，这样可行
    // 同时注意可能会有 n<=1 的情况，但是我们在这里假定不会出现
    // 实际上可能出现，需要加入形如下面的判断
    // if(n <= 1) return false;
    for(long long i=2;i<=n/i;i++)
    {
        if(n%i==0) return false;
    }
    return true;
}
```

能不能再给力一点儿？

我们有更优秀的算法，并且大多数都很复杂。有一个著名的算法叫做 AKS，时间复杂度为 $\mathcal O(\log^6n)$（我们不考虑对需要高精度的大数进行运算带来的时间复杂度增加，下同），十分优秀，但是我们先不管，因为实际上它没有 Miller-Rabin 好（这是一个确定性算法，可以给出正确答案。而 Miller-Rabin 不一定可以）。

我们有 $\mathcal O(\log n)$ 的做法，虽然是随机算法，但是这是一个优秀的**蒙特卡罗判定**算法，并且试验 $k$ 次之后错误率是 $4^{-k}$，也就是 $\dfrac{1}{4^k}$，比如试验 $16$ 次错误率就是 $\dfrac{1}{4294967296}$，非常好了。

> 什么是蒙特卡罗判定算法？
>
> 对于判断类问题，比如我们的质数判定问题，蒙特卡罗判定算法可以试验若干次，并且如果答案是 NO 则蒙特卡罗判定算法可能会返回 YES 或 NO（错误率随测验次数减小），但是如果答案是 YES 则算法必然返回 YES（互换 YES/NO 也可以）。

## 费马小定理

（咋串台了.jpg）

~~我写过费马小定理的文章你咋不去看。~~

费马小定理是指对于质数 $p$，任意满足 $p\perp a$（$a\perp b$ 在数论中代表 $\gcd(a,b)=(a,b)=1$，即 $a,b$ 互质）的 $a$ 都满足 $a^p\equiv a\pmod p$，也就是 $a^{p-1}\equiv 1\pmod p$。

所以我们只需要找一个 $a$，带入测试即可……吗？*【费马素性测试】*

费马小定理的逆定理并不一定成立。也就是如果存在 $a,p$ 满足 $a^{p-1}\equiv 1\pmod p$ 且 $a\perp p$，则 $p$ 也不一定是质数。比如 $5^{4-1}\equiv 1\bmod 4$。就算限定 $a<p$ 且 $a\neq 1$ 也不一定，比如 $2^{560}\equiv 1\pmod 561$。

甚至，就算对于所有 $a\perp n$ 都满足 $a^{n-1}\equiv 1\pmod n$，$n$ 也不一定是质数。这类数字叫做[Carmichael 数](https://oeis.org/A002997)。虽然 OEIS 中数字都不大，但是我们有 Carmichael 数 $999211956328352449$！

## 二次探测定理

就是说，如果 $p$ 是奇质数，则 $x^2\equiv 1\pmod p$ 的解为 $x\equiv \pm 1\pmod p$。这个对左边进行因式分解可以秒出来，但是因为这里是同余所以如果 $p$ 是合数那么可能可以两个括号合并得到 $p$ 的倍数。
